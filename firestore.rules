rules_version = '2';

// ==============================================
// UNSCROLL - Firestore Security Rules
// ==============================================
// Deploy with: firebase deploy --only firestore:rules

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==============================================
    // HELPER FUNCTIONS
    // ==============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate media item data
    function isValidMediaItem() {
      let data = request.resource.data;
      return data.keys().hasAll(['title', 'user_id', 'status', 'format'])
        && data.title is string
        && data.title.size() > 0
        && data.title.size() <= 500
        && data.user_id == request.auth.uid
        && data.status in ['unwatched', 'watching', 'watched']
        && data.format == 'movie'
        && (data.year == null || (data.year is int && data.year >= 1800 && data.year <= 2100))
        && (data.rating == null || (data.rating is number && data.rating >= 0 && data.rating <= 10));
    }
    
    // ==============================================
    // MEDIA ITEMS COLLECTION
    // ==============================================
    
    match /media_items/{itemId} {
      // Users can read their own media items
      allow read: if isOwner(resource.data.user_id);
      
      // Users can create media items for themselves
      allow create: if isAuthenticated() 
        && request.resource.data.user_id == request.auth.uid
        && isValidMediaItem();
      
      // Users can update their own media items
      allow update: if isOwner(resource.data.user_id)
        && request.resource.data.user_id == request.auth.uid
        && isValidMediaItem();
      
      // Users can delete their own media items
      allow delete: if isOwner(resource.data.user_id);
    }
    
    // ==============================================
    // DEFAULT: Deny all other access
    // ==============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
